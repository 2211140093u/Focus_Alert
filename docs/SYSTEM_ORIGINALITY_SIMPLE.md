
## 2. わかりやすい解説版: `docs/SYSTEM_ORIGINALITY_SIMPLE.md`
arkdown
# このシステムの独自性について（わかりやすい解説）

## はじめに

このシステムは、Googleが開発した「MediaPipe」という顔認識技術を使っていますが、それだけでは集中力を測ることはできません。このシステムでは、MediaPipeで検出した顔の特徴点を使って、**独自の方法で集中力を判定する仕組み**を作りました。

このドキュメントでは、技術的な知識がない方でも理解できるように、このシステムの独自性をわかりやすく説明します。

---

## 1. MediaPipeとは何か？

### MediaPipeができること

MediaPipeは、カメラの映像から**顔の特徴点（ランドマーク）を検出する**技術です。

例えば：
- 目の位置
- まぶたの位置
- 虹彩（目の黒い部分）の位置
- 鼻、口などの位置

これらを**座標（位置情報）として教えてくれる**だけです。

### MediaPipeができないこと

MediaPipeは「目が開いているか閉じているか」や「どこを見ているか」を**直接判定してくれません**。座標を教えてくれるだけなので、その座標を使って何を判定するかは、**私たちが自分で作る必要があります**。

---

## 2. このシステムの独自性：まばたき検出

### 2.1 EAR（Eye Aspect Ratio）という指標

**EARとは**：目がどれだけ開いているかを数値で表したものです。

- 目が開いている → EARの値が大きい
- 目が閉じている → EARの値が小さい

**このシステムの独自性**：
- MediaPipeは目の位置を教えてくれるだけですが、このシステムでは、その位置情報から**EARという数値を計算する方法を実装**しました。
- 計算式は既存の研究を参考にしていますが、**このシステムで実装した**ものです。

### 2.2 個人差に対応する仕組み

**問題**：人によって目の大きさが違うので、同じEARの値でも、ある人には「開いている」、別の人には「閉じている」と判定されてしまう可能性があります。

**このシステムの独自性**：
- 計測開始後、その人の「目が開いている時の基準値」を**自動的に学習**します。
- 基準値は、計測中に**少しずつ更新**され続けます（環境の変化にも対応）。
- 固定の閾値（例：0.25）ではなく、**その人の基準値の90%未満で閉眼と判定**する相対的な方法を使います。

**例**：
- Aさんの基準値が0.50の場合 → 0.45未満で閉眼と判定
- Bさんの基準値が0.40の場合 → 0.36未満で閉眼と判定

### 2.3 通常のまばたきと長時間閉眼を区別

**このシステムの独自性**：
- 通常のまばたき（約100-200ms）と、眠気の兆候である長時間閉眼（約400ms以上）を**区別**します。
- 長時間閉眼は、集中力低下の重要な指標として使われます。

### 2.4 まばたきのカウント方法

**このシステムの独自性**：
- 目が閉じた後、1フレーム以上20フレーム以内で開いた場合のみ「まばたき」としてカウントします。
- これにより、ノイズ（1フレーム未満の誤検出）や、長時間閉眼（20フレーム以上）を除外します。

---

## 3. このシステムの独自性：視線検出

### 3.1 視線の方向を計算する方法

**MediaPipeができること**：
- 虹彩（目の黒い部分）の位置を教えてくれる

**このシステムの独自性**：
- 虹彩の位置から、**画面のどこを見ているか**を計算します。
- 目幅で正規化することで、カメラとの距離や個人差に依存しない計算が可能です。

### 3.2 視線の逸脱を判定

**このシステムの独自性**：
- 画面中央から視線が外れているかどうかを判定します。
- 単に「外れている/いない」の二択ではなく、**0.0から1.0の連続値**で「どれくらい外れているか」を表現します。
- 一時的な視線の動きと、継続的な注意散漫を区別できます。

### 3.3 キャリブレーション機能

**このシステムの独自性**：
- ユーザーが画面中央を見た時に「これが中央だ」と設定（キャリブレーション）できます。
- 個人の視線の癖（少し左寄りに見る癖など）を補正できます。

---

## 4. このシステムの独自性：集中力スコアの計算

### 4.1 複数の指標を統合

**このシステムの独自性**：
- まばたきと視線の情報を**1つのスコア（リスクスコア）に統合**します。
- スコアは0.0（集中している）から1.0（集中力が低下している）の範囲です。

**統合の方法**：
- 長時間閉眼：70%（最も重要）
- 視線逸脱：20%
- 現在閉眼：10%

### 4.2 スムーズな変化

**このシステムの独自性**：
- リスクスコアは、**指数移動平均**という方法で平滑化されます。
- これにより、一時的なノイズではなく、**継続的な集中力低下**を検出できます。

### 4.3 アラートの出し方

**このシステムの独自性**：
- リスクスコアが0.55以上になった時にアラートを出します。
- 一度アラートを出した後、60秒間は再びアラートを出しません（クールダウン）。
- これにより、連続してアラートが出ることを防ぎます。

---

## 5. このシステムの独自性：データの記録方法

### 5.1 3種類の記録形式

**このシステムの独自性**：
- CSVファイルに、**3種類の行**を記録します：

1. **meta行**：計測の開始日時、設定パラメータなどのメタ情報
2. **event行**：ユーザーがボタンを押した時などのイベント
3. **frame行**：各フレーム（約30回/秒）の検出データ

**なぜこれが重要か**：
- 後から「この時点で何が起こったか」を分析できます。
- 検出値だけでなく、基準値や閾値も記録するので、後から再計算が可能です。

### 5.2 自動ファイル命名

**このシステムの独自性**：
- ファイル名は自動的に `session_20240101_120000.csv` のような形式になります。
- 日時が自動的に含まれるので、どの計測データかが一目でわかります。

### 5.3 記録される項目

**このシステムの独自性**：
- 以下の項目を**毎フレーム記録**します：

**まばたき関連**：
- EAR（現在値）
- EAR基準値（その人の開眼時の基準）
- EAR閾値（この値未満で閉眼と判定）
- まばたき回数
- 現在閉眼しているか
- 長時間閉眼しているか

**視線関連**：
- 視線の水平方向の位置
- 視線の垂直方向の位置
- 視線の閾値
- 視線のバイアス（キャリブレーション値）
- 視線逸脱レベル

**統合**：
- リスクスコア
- アラートが出たか

**メタ情報**：
- セッションID、参加者ID、タスク名など

---

## 6. このシステムの独自性：レポートの作成

### 6.1 自動グラフ生成

**このシステムの独自性**：
- CSVデータから、**複数のグラフを自動的に生成**します：

1. **時系列グラフ**：時間の経過とともに、リスクスコア、EAR、視線がどう変化したかを表示
2. **分布グラフ**：リスクスコア、EAR、視線の値がどのように分布しているかを表示
3. **視線散布図**：視線が画面のどの位置にあったかを表示
4. **視線ヒートマップ**：視線が集中していた場所を色の濃淡で表示

### 6.2 注意散漫区間の可視化

**このシステムの独自性**：
- ユーザーが「注意散漫」ボタンを押した区間を、グラフ上に**自動的にマーキング**します。
- これにより、「この時に集中力が低下していた」という区間を視覚的に確認できます。

### 6.3 アプリ内での表示

**このシステムの独自性**：
- レポートはHTMLファイルではなく、**アプリ内で1ページずつ表示**されます。
- 小さいモニタ（3.5インチ、320×480）でも見やすいように最適化されています。
- タッチ操作でページ送りができます。

---

## 7. このシステムの独自性：個人差への対応

### 7.1 安定した状態でのみ学習

**このシステムの独自性**：
- 目が閉じている時や、視線が外れている時は、基準値の学習を**スキップ**します。
- 安定した状態（目が開いていて、視線が中央にある）でのみ学習することで、正確な基準値を設定できます。

### 7.2 非対称な更新速度

**このシステムの独自性**：
- EAR基準値の更新で、**上昇時と下降時で異なる速度**を使います：
  - 基準値が上がる時（目がより開く）：速く更新（α=0.03）
  - 基準値が下がる時（眠気の方向）：遅く更新（α=0.005）

**なぜこれが重要か**：
- 眠気による一時的な値の低下で、基準値が誤って下がってしまうことを防ぎます。

---

## 8. このシステムの独自性：ユーザーインターフェース

### 8.1 小さいモニタへの最適化

**このシステムの独自性**：
- 3.5インチのタッチモニタ（320×480）に最適化されたGUIを実装しました。
- 情報パネル、ボタン、フォントサイズを、小さい画面でも見やすく、操作しやすく設計しました。

### 8.2 仮想キーボード

**このシステムの独自性**：
- タッチスクリーン用の**仮想キーボード**を実装しました。
- 英数字、記号、かなの3つのモードを切り替えられます。
- カーソル移動機能も実装し、文字入力の修正が可能です。

### 8.3 メインメニューシステム

**このシステムの独自性**：
- 「計測開始」「データ確認」「オプション」の3つの画面を実装しました。
- 設定（EAR閾値、リスク閾値など）を、コードを変更せずにGUIで調整できます。

---

## 9. このシステムの独自性：システム設計

### 9.1 二重プロセス構成

**問題**：
- Raspberry Pi Cameraを使うには「Picamera2」というライブラリが必要ですが、これはPython 3.13でしか動きません。
- 一方、MediaPipeはPython 3.11でしか動きません。

**このシステムの独自性**：
- **2つのプロセスに分ける**ことで解決しました：
  - **プロセス1**：Python 3.13でカメラから映像を取得し、JPEG画像として送信
  - **プロセス2**：Python 3.11でMediaPipeを使って顔検出を行い、集中力を判定
- 2つのプロセス間は、ZMQという通信方法で画像をやり取りします。

### 9.2 カメラ品質の自動最適化

**このシステムの独自性**：
- カメラの設定（明るさ、コントラスト、彩度など）を**自動的に最適化**します。
- これにより、環境が変わっても、常に良い画質で検出できます。

---

## まとめ：このシステムの独自性

### MediaPipeが提供するもの
- 顔の特徴点（ランドマーク）の検出
- 虹彩の位置情報

### このシステムが独自に実装したもの

#### アルゴリズム
1. **EAR計算式**：目の開閉を数値化
2. **適応的基準値**：個人差に対応
3. **相対閾値**：固定値ではなく、個人の基準値に基づく判定
4. **長時間閉眼の検出**：通常のまばたきと区別
5. **視線オフセット計算**：目幅で正規化した視線方向
6. **視線逸脱レベル**：連続値での表現
7. **リスクスコア統合**：複数の指標を1つのスコアに統合
8. **アラート判定**：クールダウン付きヒステリシス

#### データ記録
9. **3種類の行タイプ**：meta/event/frame
10. **自動ファイル命名**：日時ベース
11. **詳細な記録**：検出値だけでなく、基準値・閾値も記録

#### レポート生成
12. **複数グラフの自動生成**：時系列、分布、散布図、ヒートマップ
13. **注意散漫区間の可視化**：自動マーキング
14. **アプリ内表示**：小さいモニタでも見やすい

#### ユーザーインターフェース
15. **小さいモニタ最適化**：320×480に最適化
16. **仮想キーボード**：タッチ入力対応
17. **メインメニュー**：直感的な操作

#### システム設計
18. **二重プロセス構成**：異なるPythonバージョン間の通信
19. **カメラ品質自動最適化**：環境変化に対応

---

## 卒論で記載すべきポイント

### データ計測法の独自性
- **フレーム単位の詳細記録**：約30回/秒で、EAR、視線、リスクスコアを記録
- **基準値・閾値の記録**：検出値だけでなく、適応的に更新される基準値も記録
- **イベント統合**：ユーザー操作や状態変化を時系列で統合

### 記録の仕方の独自性
- **3種類の行タイプ**：meta（メタ情報）、event（イベント）、frame（フレームデータ）
- **自動命名**：日時ベースのファイル名
- **メタ情報の自動記録**：開始日時、設定パラメータ、セッション情報

### レポートへの変換の仕方の独自性
- **複数グラフの自動生成**：時系列、分布、散布図、ヒートマップ
- **注意散漫区間の可視化**：イベントから自動的に区間を復元
- **アプリ内表示**：HTMLではなく、アプリ内で1ページずつ表示
- **サマリ統計の自動計算**：平均値、パーセンタイル、回数など

### アルゴリズムの独自性
- **適応的EAR基準値**：セッション中に自動更新
- **相対閾値**：固定値ではなく、基準値に対する比率
- **リスクスコア統合**：重み付けと平滑化による統合
- **視線逸脱レベル**：二値ではなく連続値で表現

---

## 結論

このシステムは、MediaPipeのランドマーク検出機能を**基盤として使用**していますが、集中力をモニタリングするための**アルゴリズムとシステム設計は、すべて独自に実装**したものです。

特に、個人差に対応する適応的基準値、相対閾値による判定、複数の指標を統合したリスクスコア、詳細なデータ記録形式、自動レポート生成システムなどは、このシステムの**独自の貢献**です。