# システムの独自性に関する技術文書

## 概要

本システムは、MediaPipeのFace Meshを基盤として使用しつつ、集中力モニタリングのための独自の機能とアルゴリズムを実装しています。本ドキュメントでは、MediaPipe由来の機能と本システム独自の実装を明確に区別し、卒論で記載すべき独自性をまとめます。

---

## 1. EAR（Eye Aspect Ratio）について

### MediaPipe由来の部分

**MediaPipeが提供する機能**:
- **顔ランドマーク検出**: Face Meshモデルによる468点（または478点）の顔ランドマーク検出
- **虹彩検出**: `refine_landmarks=True`時の虹彩ランドマーク（468-478番）
- **ランドマーク座標**: 各ランドマークの正規化座標（x, y, z）

**MediaPipeが提供しないもの**:
- EAR（Eye Aspect Ratio）の計算式
- まばたき検出アルゴリズム
- 閾値の設定方法

### 本システム独自の実装

#### 1.1 EAR計算式の実装

**独自性**: EARの計算式は、MediaPipeのランドマークを使用して**本システムで独自に実装**されています。

**実装内容** (`src/features/blink.py`):
@staticmethod
def _ear(pts):
    # pts: [p1,p2,p3,p4,p5,p6] = [外側, 上まぶた1, 下まぶた1, 内側, 下まぶた2, 上まぶた2]
    p1,p2,p3,p4,p5,p6 = pts
    def d(a,b):
        return np.hypot(a.x - b.x, a.y - b.y)
    vert = d(p2,p5) + d(p3,p6)  # 垂直方向の距離の和
    horiz = d(p1,p4)             # 水平方向の距離
    if horiz <= 1e-6:
        return 0.0
    return vert / (2.0 * horiz)  # EAR = 垂直距離の平均 / 水平距離**使用するランドマーク**:
- 左目: [33, 160, 158, 133, 153, 144]
- 右目: [263, 387, 385, 362, 380, 373]

**独自性のポイント**:
- EAR計算式は一般的な手法（Soukupová & Čech, 2016など）を参考にしているが、**本システムで実装**
- MediaPipeはランドマーク座標のみを提供し、EAR計算は行わない

#### 1.2 適応的EAR基準値の更新

**独自性**: 開眼時のEAR基準値を**セッション中に適応的に更新**する機能

**実装内容**:
# 閉眼していない時に開眼基準値を更新（保守的）
if self.adapt_enabled:
    candidate = max(ear, self.ear_smooth)
    if not self.closed:
        self.open_baseline = (1 - self.base_alpha) * self.open_baseline + self.base_alpha * candidate**独自性のポイント**:
- **EWMA（指数移動平均）による基準値の適応的更新**
- 瞬目中に基準値が下がりすぎないよう、現在値と平滑値の大きい方を採用
- 個人差や環境変化に対応

#### 1.3 相対閾値による閉眼判定

**独自性**: 固定閾値ではなく、**基準値に対する相対閾値**を使用

**実装内容**:
# 相対しきい値: 基準値の指定比率未満で「閉眼」とみなす
thresh = self.open_baseline * self.ear_threshold_ratio**独自性のポイント**:
- 固定閾値（例: 0.25）ではなく、個人の基準値に基づく相対判定
- 個人差に対応しやすい

#### 1.4 長時間閉眼の検出

**独自性**: 通常のまばたきと**長時間閉眼（眠気の兆候）を区別**

**実装内容**:
self.long_close_threshold_frames = 12  # 30fps時におよそ400ms
long_close = bool(self.long_close_frames >= self.long_close_threshold_frames)**独自性のポイント**:
- フレーム数ベースの長時間閉眼検出
- 集中力低下の指標として使用

#### 1.5 まばたきカウントのロジック

**独自性**: 閉眼→開眼の遷移時に、**一定範囲の継続フレーム数でのみカウント**

**実装内容**:
# 閉→開の遷移時に、一定範囲の継続フレーム数なら「瞬目」とカウント
if self.closed and 1 <= self.close_frames <= 20:
    self.blinks += 1**独自性のポイント**:
- 1フレーム未満のノイズを除外
- 20フレーム（約667ms）以上の閉眼は長時間閉眼として扱い、通常のまばたきとしてカウントしない

---

## 2. 視線検出について

### MediaPipe由来の部分

**MediaPipeが提供する機能**:
- 虹彩ランドマーク（468-471, 473-476番）
- 目のランドマーク（目頭・目尻など）

### 本システム独自の実装

#### 2.1 目幅正規化による視線オフセット計算

**独自性**: 虹彩の位置を**目幅で正規化**して視線方向を計算

**実装内容** (`src/features/gaze.py`):ython
def norm_offset(c, inner, outer):
    width = np.linalg.norm(inner - outer) + 1e-6
    # 目頭→目尻方向への符号付き射影
    dirv = (outer - inner) / width
    vec = (c - 0.5 * (inner + outer))
    # 水平（目のラインに沿った方向）
    relx = np.dot(vec, dirv) / (width * 0.5)
    # 垂直（目のラインに直交する方向）
    perp = np.array([-dirv[1], dirv[0]])
    rely = np.dot(vec, perp) / (width * 0.5)
    return float(relx), float(rely)**独自性のポイント**:
- 目幅で正規化することで、カメラ距離や個人差に依存しない
- 水平・垂直方向を独立に計算

#### 2.2 視線逸脱レベルの指数移動平均

**独自性**: 視線逸脱を**0.0-1.0の連続値**として表現

**実装内容**:thon
off = (abs(adj) > thresh) or (abs(adj_y) > thresh_y)
self.off_level = (1 - self.off_alpha) * self.off_level + self.off_alpha * (1.0 if off else 0.0)**独自性のポイント**:
- 二値判定ではなく、逸脱の程度を連続値で表現
- 一時的な逸脱と継続的な逸脱を区別

#### 2.3 中心キャリブレーション機能

**独自性**: ユーザーが画面中央を注視した時点で**視線の中心をキャリブレーション**

**実装内容**:
def calibrate_center(self):
    # 現在の平滑化済み位置を中心バイアスとして保存
    self.bias = float(self.center_smooth[0])
    self.bias_y = float(self.center_smooth[1])**独自性のポイント**:
- 個人の視線の中心を手動で設定可能
- バイアス補正により、個人差に対応

---

## 3. リスクスコア統合アルゴリズム

### 完全に独自の実装

**独自性**: まばたきと視線の検出結果を統合して、**集中力低下のリスクスコアを計算**

**実装内容** (`src/fusion.py`):
def update(self, feats, perso):
    blink = feats['blink']
    gaze = feats['gaze']
    long_close = 1.0 if blink.get('long_close', False) else 0.0
    closed_now = 1.0 if blink.get('is_closed', False) else 0.0
    off_lvl = float(gaze.get('gaze_off_level', 1.0 if gaze.get('gaze_off', False) else 0.0))
    
    # 重み付け統合
    raw = 0.7 * long_close + 0.2 * off_lvl + 0.1 * closed_now
    # 指数移動平均で平滑化
    self.score = self.alpha * raw + (1 - self.alpha) * self.score
    return self.score
**独自性のポイント**:
- **重み付け**: 長時間閉眼70%、視線逸脱20%、現在閉眼10%
- **平滑化**: 指数移動平均（α=0.3）で一時的なノイズを除去
- **アラート判定**: クールダウン付きヒステリシス（閾値0.55、クールダウン60秒）

---

## 4. データ記録システム

### 完全に独自の実装

#### 4.1 CSVログ形式

**独自性**: **3種類の行タイプ**（meta/event/frame）を持つCSV形式

**実装内容** (`src/logger.py`):
# 行タイプ
- 'meta': セッションのメタ情報（開始日時、設定パラメータなど）
- 'event': イベント（ブロック開始/終了、マーカー、メモなど）
- 'frame': 各フレームの検出データ**独自性のポイント**:
- フレーム単位の詳細データとイベントを統合
- メタ情報を自動記録（開始日時、設定パラメータなど）
- 自動ファイル命名（`session_YYYYMMDD_HHMMSS.csv`）

#### 4.2 記録される項目

**独自性**: 以下の項目を**フレーム単位で記録**

**記録項目**:
- **まばたき**: `ear`, `ear_base`, `ear_thr`, `blink_count`, `is_closed`, `long_close`
- **視線**: `gaze_horiz`, `gaze_y`, `gaze_thr`, `gaze_bias`, `gaze_offlvl`
- **統合**: `risk`, `alert`
- **メタ**: `session`, `participant`, `task`, `phase`, `block_id`

**独自性のポイント**:
- 検出値だけでなく、基準値・閾値・バイアスも記録
- 後から分析・再計算が可能

#### 4.3 イベント記録

**独自性**: ユーザー操作や状態変化を**イベントとして記録**

**イベントタイプ**:
- `block_start/end`: ブロックの開始/終了
- `marker`: 任意のマーカー
- `distractor_start/end`: 注意散漫区間
- `calibrate_center`: 視線キャリブレーション
- `note`: メモ（ユーザー入力）

**独自性のポイント**:
- イベントとフレームデータを時系列で統合
- 後から区間分析が可能

---

## 5. レポート生成システム

### 完全に独自の実装

#### 5.1 レポート生成アルゴリズム

**独自性**: CSVログから**複数のグラフと統計を自動生成**

**生成されるグラフ** (`scripts/report.py`):
1. **時系列グラフ**: リスク、EAR、視線の時系列変化（3つのサブプロット）
2. **分布ヒストグラム**: リスク、EAR、視線の分布
3. **視線散布図**: 視線のX-Y座標の散布図
4. **視線ヒートマップ**: 視線の密度分布

**独自性のポイント**:
- 注意散漫区間（distractor）を自動的に可視化
- アラート発火時点をマーキング
- サマリ統計の自動計算

#### 5.2 アプリ内レポートビューア

**独自性**: HTMLではなく、**アプリ内で1ページずつ表示**

**実装内容** (`src/report_viewer.py`):
- 各グラフを個別のPNG画像として保存
- メタデータ（JSON）でページ情報を管理
- ページ送り機能で1つずつ表示

**独自性のポイント**:
- 小さいモニタ（320×480）でも見やすい
- タッチ操作でページ送り
- メタ情報・統計・グラフを順に表示

---

## 6. パーソナライゼーション機能

### 完全に独自の実装

#### 6.1 安定フレーム判定

**独自性**: **連続で条件を満たしたフレーム数**をカウントして学習

**実装内容** (`src/personalize.py`):
def _is_stable(self, feats, status, alert):
    has_face = bool(status.get('has_face', True))
    b = feats.get('blink', {})
    g = feats.get('gaze', {})
    cond = has_face
    if self.skip_on_closed:
        cond = cond and (not b.get('is_closed', False))
    if self.skip_on_offgaze:
        cond = cond and (not g.get('gaze_off', False))
    if self.skip_on_alert:
        cond = cond and (not alert)
    return cond**独自性のポイント**:
- 閉眼・視線逸脱・アラート時は学習をスキップ
- 安定した状態でのみ基準値を更新

#### 6.2 非対称EWMA更新

**独自性**: EAR基準値の更新で、**上昇時と下降時で異なる係数**を使用

**実装内容**:
if x >= base:
    a = self.ear_alpha_up      # 0.03（速い）
else:
    a = self.ear_alpha_down    # 0.005（遅い、保守的）
self.state['ear_baseline'] = (1 - a) * self.open_baseline + a * x**独自性のポイント**:
- 基準値の上昇は速く、下降は遅く（眠気の誤検出を防ぐ）

---

## 7. GUIシステム

### 完全に独自の実装

#### 7.1 3.5インチタッチモニタ最適化

**独自性**: 320×480の小さい画面に最適化されたGUI

**実装内容**:
- 情報パネルのコンパクト化
- ボタンの配置とサイズの最適化
- フォントサイズの調整

#### 7.2 仮想キーボード

**独自性**: タッチスクリーン用の**仮想キーボード**を実装

**機能**:
- 英数字・記号・かなの3モード
- カーソル移動機能
- シフト機能（大文字入力）

#### 7.3 レポートビューア

**独自性**: アプリ内でレポートを**1ページずつ表示**

**機能**:
- ページ送り（前/次）
- 画像の自動リサイズ
- メタ情報・統計・グラフの順次表示

---

## 8. システムアーキテクチャ

### 独自の設計

#### 8.1 二重プロセス構成

**独自性**: Picamera2とMediaPipeのPythonバージョン不一致に対応

**実装内容**:
- **送信プロセス**: System Python 3.13でPicamera2を使用
- **受信プロセス**: pyenv Python 3.11でMediaPipeを使用
- **通信**: ZMQ（PUB/SUB）でJPEG画像を配信

**独自性のポイント**:
- 異なるPythonバージョン間での通信
- プロセス分離による安定性

#### 8.2 カメラ品質最適化

**独自性**: カメラ設定を**自動的に最適化**

**実装内容** (`src/capture.py`):
self.cap.set(cv2.CAP_PROP_AUTO_EXPOSURE, 0.75)
self.cap.set(cv2.CAP_PROP_AUTOFOCUS, 1)
self.cap.set(cv2.CAP_PROP_AUTO_WB, 1)
self.cap.set(cv2.CAP_PROP_BRIGHTNESS, 0.5)
self.cap.set(cv2.CAP_PROP_CONTRAST, 0.5)
self.cap.set(cv2.CAP_PROP_SATURATION, 0.5)
self.cap.set(cv2.CAP_PROP_SHARPNESS, 0.5)---

## まとめ：システム独自性の一覧

### MediaPipe由来（外部ライブラリ）
- 顔ランドマーク検出
- 虹彩ランドマーク検出
- ランドマーク座標の提供

### 本システム独自の実装

#### アルゴリズム・計算
1. **EAR計算式の実装**（MediaPipeのランドマークを使用）
2. **適応的EAR基準値の更新**（EWMA、非対称更新）
3. **相対閾値による閉眼判定**
4. **長時間閉眼の検出**（フレーム数ベース）
5. **まばたきカウントロジック**（フレーム範囲による判定）
6. **目幅正規化による視線オフセット計算**
7. **視線逸脱レベルの指数移動平均**
8. **リスクスコア統合アルゴリズム**（重み付け、平滑化）
9. **クールダウン付きヒステリシス**（アラート判定）

#### データ記録・管理
10. **3種類の行タイプを持つCSVログ形式**（meta/event/frame）
11. **自動ファイル命名**（日時ベース）
12. **メタ情報の自動記録**（開始日時、設定パラメータ）
13. **イベント記録システム**（ブロック、マーカー、メモなど）

#### レポート生成
14. **複数グラフの自動生成**（時系列、分布、散布図、ヒートマップ）
15. **注意散漫区間の自動可視化**
16. **アプリ内レポートビューア**（1ページずつ表示）
17. **レポートメタデータ形式**（JSON、ページ情報）

#### パーソナライゼーション
18. **安定フレーム判定**（連続フレーム数のカウント）
19. **非対称EWMA更新**（上昇/下降で異なる係数）
20. **視線バイアスの自動補正**

#### GUI・操作性
21. **3.5インチタッチモニタ最適化**（320×480）
22. **仮想キーボード**（英数字・記号・かな、カーソル移動）
23. **メインメニューシステム**（計測開始/データ確認/オプション）
24. **設定GUI**（パラメータ調整、保存/読み込み）

#### システム設計
25. **二重プロセス構成**（ZMQ通信）
26. **カメラ品質自動最適化**
27. **エラーハンドリング**（連続失敗検出、ダミーフレーム表示）

---

## 卒論記載用の要点

### データ計測法の独自性
- **フレーム単位の詳細記録**: EAR、視線、リスクスコアを毎フレーム記録
- **基準値・閾値の記録**: 検出値だけでなく、適応的に更新される基準値も記録
- **イベント統合**: ユーザー操作や状態変化を時系列で統合

### 記録の仕方の独自性
- **3種類の行タイプ**: meta（メタ情報）、event（イベント）、frame（フレームデータ）
- **自動命名**: 日時ベースのファイル名（`session_YYYYMMDD_HHMMSS.csv`）
- **メタ情報の自動記録**: 開始日時、設定パラメータ、セッション情報

### レポートへの変換の仕方の独自性
- **複数グラフの自動生成**: 時系列、分布、散布図、ヒートマップ
- **注意散漫区間の可視化**: distractorイベントから自動的に区間を復元
- **アプリ内表示**: HTMLではなく、アプリ内で1ページずつ表示
- **サマリ統計の自動計算**: 平均値、パーセンタイル、回数など

### アルゴリズムの独自性
- **適応的EAR基準値**: セッション中にEWMAで更新
- **相対閾値**: 固定値ではなく、基準値に対する比率
- **リスクスコア統合**: 重み付けと平滑化による統合
- **視線逸脱レベル**: 二値ではなく連続値で表現

---

## 参考文献・関連研究

### EAR（Eye Aspect Ratio）
- Soukupová, T., & Čech, J. (2016). Real-time eye blink detection using facial landmarks. *21st Computer Vision Winter Workshop*.

**注意**: EARの概念自体は既存研究に基づくが、本システムでの実装（適応的基準値、相対閾値など）は独自の拡張。

### MediaPipe
- Google MediaPipe: https://mediapipe.dev/
- Face Mesh: 468点（または478点）の顔ランドマーク検出

---

## 結論

本システムは、MediaPipeのランドマーク検出機能を基盤として使用しつつ、**集中力モニタリングのための独自のアルゴリズムとシステム設計**を実装しています。特に、適応的EAR基準値、相対閾値、リスクスコア統合、データ記録形式、レポート生成システムなどは、本システム独自の実装です。