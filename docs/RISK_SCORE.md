# リスクスコアの判定方法

## 概要

リスクスコアは、まばたき検出と視線検出の結果を統合して、集中力の低下を0.0～1.0の値で表現します。

## 計算式

### 基本計算

```python
# 各指標の重み付け
long_close = 1.0 if 長時間閉眼 else 0.0        # 重み: 0.7 (70%)
off_lvl = 視線逸脱レベル (0.0-1.0)              # 重み: 0.2 (20%)
closed_now = 1.0 if 現在閉眼 else 0.0          # 重み: 0.1 (10%)

# 生スコアの計算
raw_score = 0.7 × long_close + 0.2 × off_lvl + 0.1 × closed_now

# 指数移動平均で平滑化（α = 0.3）
risk_score = 0.3 × raw_score + 0.7 × 前回のrisk_score
```

### 各指標の詳細

#### 1. 長時間閉眼（long_close）: 重み 70%
- **意味**: 約400ms以上（30fps時12フレーム以上）目が閉じている
- **値**: 1.0（長時間閉眼）または 0.0（それ以外）
- **重要性**: 最も重要な指標（眠気・集中力低下の強力な兆候）

#### 2. 視線逸脱レベル（off_lvl）: 重み 20%
- **意味**: 視線が画面中央から逸脱している程度
- **値**: 0.0（中央注視）～ 1.0（長時間逸脱）
- **計算**: 視線逸脱の指数移動平均（EMA）
- **重要性**: 注意散漫の指標

#### 3. 現在閉眼（closed_now）: 重み 10%
- **意味**: 現在のフレームで目が閉じているか
- **値**: 1.0（閉眼）または 0.0（開眼）
- **重要性**: 一時的な閉眼を検出（通常のまばたきも含む）

### 平滑化（EMA: Exponential Moving Average）

リスクスコアは指数移動平均で平滑化されます：

- **α = 0.3**: 新しい値の重みが30%、過去の値の重みが70%
- **効果**: 急激な変動を抑え、滑らかな変化を表現
- **意味**: 一時的なノイズではなく、継続的な集中力低下を検出

## アラート判定

### アラート発火条件

```python
if risk_score >= 0.55 and クールダウン中でない:
    アラート発火
```

- **閾値**: 0.55（55%）
- **クールダウン**: 前回のアラートから60秒以内は再発火しない
- **意味**: リスクスコアが55%以上で、かつ60秒以内にアラートが出ていない場合に発火

### クールダウン機能

- **目的**: アラートの連続発火を防ぐ
- **期間**: 60秒
- **効果**: アラートが頻繁に出すぎることを防ぐ

## リスクスコアの解釈

### 0.0 ～ 0.3: 低リスク（集中している）
- **状態**: 正常な集中状態
- **特徴**: 
  - 長時間閉眼なし
  - 視線が中央を注視
  - 通常のまばたきのみ
- **アクション**: 特になし

### 0.3 ～ 0.55: 中リスク（注意が必要）
- **状態**: 集中力がやや低下
- **特徴**: 
  - 短時間の閉眼が増加
  - 視線がやや逸脱
  - まばたきの頻度が変化
- **アクション**: 軽い休憩を検討

### 0.55 ～ 1.0: 高リスク（アラート発火）
- **状態**: 集中力が大きく低下
- **特徴**: 
  - 長時間閉眼が発生
  - 視線が大きく逸脱
  - 眠気の兆候
- **アクション**: 休憩を推奨（アラート表示）

## 調整可能なパラメータ

### アラート閾値（fusion.py）

```python
self.hi = 0.55  # アラートのしきい値（変更可能）
```

- **現在の値**: 0.55
- **調整範囲**: 0.40 ～ 0.70
- **低い値（0.40-0.50）**: より敏感にアラート（早めに警告）
- **高い値（0.60-0.70）**: より厳格にアラート（確実な集中力低下のみ）

### 平滑化係数（fusion.py）

```python
self.alpha = 0.3  # 平滑化係数（変更可能）
```

- **現在の値**: 0.3
- **調整範囲**: 0.1 ～ 0.5
- **低い値（0.1-0.2）**: より滑らか（変化が遅い）
- **高い値（0.4-0.5）**: より敏感（変化が速い）

### 重み付け（fusion.py）

```python
raw = 0.7 * long_close + 0.2 * off_lvl + 0.1 * closed_now
```

- **現在の重み**: 長時間閉眼70%、視線逸脱20%、現在閉眼10%
- **調整**: 個人の特性に応じて変更可能

## 実際の動作例

### 例1: 正常な集中状態
```
長時間閉眼: 0.0
視線逸脱: 0.0
現在閉眼: 0.0
→ raw_score = 0.0
→ risk_score ≈ 0.0（低リスク）
```

### 例2: 通常のまばたき
```
長時間閉眼: 0.0
視線逸脱: 0.0
現在閉眼: 1.0（一瞬）
→ raw_score = 0.1
→ risk_score ≈ 0.03（低リスク、すぐに戻る）
```

### 例3: 視線が逸脱
```
長時間閉眼: 0.0
視線逸脱: 0.8（長時間逸脱）
現在閉眼: 0.0
→ raw_score = 0.16
→ risk_score ≈ 0.05-0.15（低～中リスク）
```

### 例4: 長時間閉眼（眠気）
```
長時間閉眼: 1.0
視線逸脱: 0.3
現在閉眼: 1.0
→ raw_score = 0.7 + 0.06 + 0.1 = 0.86
→ risk_score ≈ 0.6-0.7（高リスク、アラート発火）
```

## トラブルシューティング

### アラートが出ない

1. **閾値を下げる**
   - `fusion.py`の`self.hi`を`0.45`に変更

2. **重みを調整**
   - 長時間閉眼の重みを上げる（0.7 → 0.8）

### アラートが出すぎる

1. **閾値を上げる**
   - `fusion.py`の`self.hi`を`0.65`に変更

2. **平滑化を強める**
   - `fusion.py`の`self.alpha`を`0.2`に変更

3. **クールダウンを延長**
   - `app.py`の`cooldown_sec`を`120.0`に変更

