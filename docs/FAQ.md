# よくある質問（FAQ）

## 解像度について

### Q: `--width 640 --height 480`で指定しているのは何の縦横幅ですか？

**A: カメラから取得するフレームの解像度（ピクセル）です。**

- `--width`: カメラから取得するフレームの幅（ピクセル）
- `--height`: カメラから取得するフレームの高さ（ピクセル）

この解像度は、MediaPipeによる顔検出・虹彩検出の精度に影響します。解像度が高いほど検出精度が向上しますが、処理負荷も増加します。

### 表示解像度との関係

- **PC環境**: デフォルトではカメラ解像度がそのまま表示されます
  - 例: `--width 1280 --height 720`で起動すると、1280×720で表示されます
  - 表示解像度を変更したい場合: `--display-width 1920 --display-height 1080`を追加

- **Raspberry Pi環境**: 3.5インチタッチモニタ（320×480）に固定表示されます
  - カメラ解像度は高く設定できますが、表示は320×480にリサイズされます
  - 例: `--width 1280 --height 720`でカメラから高解像度で取得し、320×480で表示

### 推奨設定

- **PCでの動作確認**: `--width 1280 --height 720`（または`--width 1920 --height 1080`）
- **Raspberry Pi**: `--width 1280 --height 720`（カメラ解像度を高く、表示は自動で320×480）

## まばたき検出について

### Q: まばたきが正常に検出されない

**A: 以下の方法で改善できます。**

#### 1. EAR閾値の調整

まばたき検出の感度を調整：

```bash
# 閾値を下げる（より敏感に検出）
python src/app.py --ear-threshold-ratio 0.85 --width 1280 --height 720

# 閾値を上げる（より厳格に検出）
python src/app.py --ear-threshold-ratio 0.95 --width 1280 --height 720
```

- デフォルト: `0.90`（基準値の90%未満で閉眼と判定）
- 低い値（0.80-0.85）: より敏感にまばたきを検出
- 高い値（0.95-0.98）: より厳格にまばたきを検出

#### 2. EAR基準値の初期値調整

個人差に対応：

```bash
# EAR基準値を高く設定（目が大きい人向け）
python src/app.py --ear-baseline-init 0.50 --width 1280 --height 720

# EAR基準値を低く設定（目が小さい人向け）
python src/app.py --ear-baseline-init 0.40 --width 1280 --height 720
```

- デフォルト: `0.45`
- 通常の範囲: `0.35-0.55`

#### 3. 解像度の向上

解像度を上げることで検出精度が向上：

```bash
python src/app.py --width 1280 --height 720 --ear-threshold-ratio 0.85
```

#### 4. 画面表示での確認

画面上部の情報パネルで以下を確認：
- `EAR`: 現在のEAR値（0.3-0.6程度が正常）
- `ear_base`: EAR基準値（開眼時の基準）
- `ear_thr`: EAR閾値（この値未満で閉眼と判定）
- `Blinks`: まばたき回数（増えているか確認）

### まばたき検出の仕組み

1. **EAR（Eye Aspect Ratio）の計算**
   - 目のランドマークから、目の縦横比を計算
   - 目が開いているほどEAR値が大きい

2. **基準値の適応**
   - 開眼時のEAR値を基準値として記録
   - セッション中に適応的に更新

3. **閾値による判定**
   - 基準値 × 閾値比率 未満で「閉眼」と判定
   - 閉眼→開眼の遷移で「まばたき」としてカウント

## カメラ品質について

### Q: カメラからできる限り綺麗な画像を取り込みたい

**A: 以下の設定で最適化されています。**

#### 自動設定（デフォルト）

システムは以下の設定を自動的に適用します：

- **自動露出**: 明るさを自動調整
- **自動フォーカス**: 焦点を自動調整（対応カメラのみ）
- **自動ホワイトバランス**: 色温度を自動調整
- **明るさ・コントラスト・彩度・シャープネス**: 適度な値に設定

#### 解像度の設定

カメラの最大解像度を使用：

```bash
# 高解像度で取得（カメラのスペックに応じて）
python src/app.py --width 1920 --height 1080

# または、カメラの最大解像度を確認して設定
# Windows: デバイスマネージャーでカメラの仕様を確認
# Mac/Linux: v4l2-ctl --list-formats-ext
```

#### 手動調整（必要に応じて）

`src/capture.py`の`_OpenCVCamera.open()`メソッドを編集することで、以下の設定を手動調整できます：

```python
# 明るさを調整（0.0-1.0）
self.cap.set(cv2.CAP_PROP_BRIGHTNESS, 0.6)

# コントラストを調整（0.0-1.0）
self.cap.set(cv2.CAP_PROP_CONTRAST, 0.7)

# 彩度を調整（0.0-1.0）
self.cap.set(cv2.CAP_PROP_SATURATION, 0.6)

# シャープネスを調整（0.0-1.0）
self.cap.set(cv2.CAP_PROP_SHARPNESS, 0.7)
```

#### 照明環境の改善

- 十分な明るさを確保（顔がはっきり見える程度）
- 逆光を避ける
- 均一な照明を心がける

#### カメラの位置

- 顔が画面の中央に来るように配置
- カメラと顔の距離: 50-80cm程度
- カメラの角度: 正面を向く

## レポートについて

### Q: レポートはどうやって作成すればよいですか？

**A: 以下の手順で作成できます。**

#### 基本的な作成方法

```bash
python scripts/report.py --log logs/pc_test.csv --out reports/report.html
```

#### 詳細な手順

1. **計測の実行**
   ```bash
   python src/app.py --cam 0 --width 1280 --height 720 --log logs/session1.csv
   ```

2. **レポートの生成**
   ```bash
   python scripts/report.py --log logs/session1.csv --out reports/session1_report.html
   ```

3. **レポートの確認**
   - ブラウザで`reports/session1_report.html`を開く

詳細は [レポート作成ガイド](REPORT_GUIDE.md) を参照してください。

### Q: どのような項目を記録し、どのようにレポートにまとめているか

**A: 以下の項目を記録し、可視化しています。**

#### 記録される項目

1. **まばたき検出データ**
   - EAR値、基準値、閾値
   - まばたき回数、閉眼状態、長時間閉眼

2. **視線検出データ**
   - 視線のX-Yオフセット
   - 視線逸脱レベル、閾値、バイアス

3. **統合スコア**
   - リスクスコア（0.0-1.0）
   - アラート発火フラグ

4. **イベント**
   - ブロック開始/終了
   - マーカー、注意散漫区間

#### レポートの内容

1. **時系列グラフ**: リスクスコア、EAR、視線の変化を時系列で表示
2. **分布ヒストグラム**: 各指標の分布を表示
3. **視線の2次元表示**: 視線のX-Y座標の散布図とヒートマップ
4. **サマリ統計**: 平均値、パーセンタイル、回数などの統計情報

詳細は [レポート作成ガイド](REPORT_GUIDE.md) を参照してください。

## その他の質問

### PCで解像度が低すぎる

**解決方法**:
```bash
# 高解像度で起動
python src/app.py --width 1280 --height 720 --log logs/test.csv

# または、表示解像度を指定
python src/app.py --width 1280 --height 720 --display-width 1920 --display-height 1080
```

### Raspberry Piでカメラが認識されない

```bash
# カメラの確認
libcamera-hello --list-cameras

# カメラのテスト
libcamera-hello
```

### パフォーマンスが低い

- 解像度を下げる: `--width 640 --height 480`
- 他のアプリケーションを閉じる
- Raspberry Piでは`--width 1280 --height 720`を推奨

